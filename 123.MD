# Промт для разработки проекта ZalypaSPB

## Основные требования:
1. **Система авторизации**:
   - Регистрация только по инвайтам от существующих пользователей.
   - Количество инвайтов зависит от роли:
     - Админы: ∞
     - Модераторы: 10/месяц
     - Пользователи: 2/месяц
   - Админ может изменять лимиты инвайтов для ролей.
   - Авторизация на сайте по логину/паролю.

2. **Ключи доступа**:
   - Генерация ключей доступна только админам/модераторам через:
     - Веб-панель
     - Discord-бота
   - Ключи имеют срок действия (15 минут для кодов привязки, настраиваемое время для продуктов).
   - Время ключа начинает отсчет только после привязки к аккаунту.
   - Свободные ключи отображаются в веб-интерфейсе с таймером.

3. **Интеграция с Discord**:
   - Бот автоматически:
     - Выдает/снимает роли (User/Mod/Admin) при изменении прав на сайте.
     - Привязывает аккаунты через команду /code (генерирует временный код).
     - Обрабатывает команду /redeem для активации ключей.
   - Логи действий сохраняются в отдельный Discord-канал.
   - Привязка аккаунта к серверу через временный код (15 мин).

4. **Ролевая модель**:
   - Пользователи:
     - Просмотр статистики
     - Привязка ключей
   - Support:
     - Просмотр статистики пользователей
     - Бан аккаунтов
   - Модераторы:
     - Генерация ключей
     - Управление пользователями
   - Админы:
     - Полный контроль системы
     - Загрузка новых версий лоадера
     - Управление ключами, пользователями, ролями.
     - Редактирование квот инвайтов.
     - Удаление пользователей и смена их паролей.

5. **Безопасность**:
   - Запрет множественной регистрации с одного Discord-аккаунта/IP.
   - Автоматическая проверка ролей Discord при каждом входе.
   - Шифрование критичных данных в БД.

6. **Логирование**:
   - Отдельные логи для:
     - Действий пользователей
     - Ошибок системы
     - Модерации
   - Интеграция логов с Discord-каналами через webhook.

7. **Технические требования**:
   - Единая БД (PostgreSQL/MySQL) для сайта и бота.
   - Модульная архитектура для легкого расширения.
   - Админ-панель с:
     - Управлением ключами
     - Редактором ролей
     - Журналом логов
     - Системой банов
   - Сервер на Ubuntu 22.04.5 LTS

## Детали реализации:
- **Веб-часть**:
  - Фреймворк: Django/Flask (Python)
  - WebSocket для real-time уведомлений
  - REST API для интеграции с ботом
  - Адаптивный интерфейс с отображением:
    - Счета времени ключей
    - Статистики пользователя
    - Системы инвайтов

- **Discord-бот**:
  - Библиотека: discord.py
  - Команды:
    - /generate_key [тип] [срок]
    - /ban @user
    - /unban @user
    - /stats @user
  - Автоматическая синхронизация ролей через Guild Member Update

- **База данных**:
  - Таблицы:
    - Users (site + discord данные)
    - Keys (статус, срок, владелец)
    - Invites (код, создатель, использован)
    - Roles (привязка к Discord role_id)
    - Logs (действия + ошибки)

## Инфраструктура:
1. **Зависимости**:
   - Python 3.10+
   - Redis для кеширования
   - Nginx + Gunicorn
   - Systemd для управления процессами

2. **Конфигурация**:
   - Отдельные файлы:
     - config.yaml (настройки ролей, ID каналов)
     - .env (токены, доступы к БД)
   - Шифрование секретов через ansible-vault

3. **Установка**:
   - Скрипт init.sh для:
     - Установки зависимостей
     - Настройки firewall
     - Инициализации БД
   - Интеграция с Certbot для HTTPS при необходимости

## Тестирование:
- Юнит-тесты для:
  - Генерации ключей
  - Механики инвайтов
  - Синхронизации ролей

## Документация:
- README.md с:
  - Схемой архитектуры
  - Инструкцией по развертыванию
  - Примеры конфигов